<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Product</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/productDetails.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">
    <%- include("../partials/admin/header.ejs") %>
    <div class="flex min-h-screen">
        <%- include("../partials/admin/sidebar.ejs") %>
             
            <main class="main-content flex-1 p-6 md:ml-10">
                <h1 class="text-2xl font-bold mb-6">Add New Product</h1>
                <form class="bg-white p-6 rounded-lg shadow-md" enctype="multipart/form-data"
                    action="/admin/product/add" method="POST">
                        <div class="form-field-grid">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                                <input type="text" id="name" name="name" class="mt-1 block w-full custom-input" value="<%= formData?.name ||'' %>">
                                <p data-error="name" class="text-red-500 text-xs italic">
                                    <%= errors? errors.name: "" %>
                                </p>
                            </div>
                            <div>
                                <label for="modelNumber" class="block text-sm font-medium text-gray-700">Model
                                    Number</label>
                                <input type="text" id="modelNumber" name="modelNumber"
                                    class="mt-1 block w-full custom-input" value="<%= formData?.modelNumber ||'' %>">
                                <p data-error="modelNumber" class="text-red-500 text-xs italic">
                                    <%=errors? errors.modelNumber : '' %>
                                </p>
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="category" name="category" class="mt-1 block w-full custom-select">
                                    <option value="" selected>Select Category</option>
                                    <% categories.forEach(category=> { %>
                                        <option value="<%= category.name%>" >
                                            <%= category.name %>
                                        </option>
                                        <% }) %>
                                </select>
                                 <p data-error="category" class="text-red-500 text-xs italic">
                                    <%=errors? errors. category : '' %>
                            </div>
                            <div>
                                <label for="color" class="block text-sm font-medium text-gray-700">Color</label>
                                <input type="text" id="color" name="color" class="mt-1 block w-full custom-input" value="<%= formData?.color ||'' %>">
                                <p data-error="color" class="text-red-500 text-xs italic">
                                    <%=errors? errors.color : '' %>
                                </p>
                            </div>
                            
                            <div>
                                <label for="brand" class="block text-sm font-medium text-gray-700">Brand</label>
                                <input type="text" id="brand" name="brand" class="mt-1 block w-full custom-input" value="<%= formData?.brand ||'' %>">
                                <p data-error="brand" class="text-red-500 text-xs italic">
                                    <%=errors? errors.brand :'' %>
                                </p>
                            </div>
                            <div>
                                <label for="CPU" class="block text-sm font-medium text-gray-700">CPU</label>
                                <input type="text" id="CPU" name="CPU" class="mt-1 block w-full custom-input" value="<%= formData?.CPU ||'' %>">
                                <p data-error="CPU" class="text-red-500 text-xs italic">
                                    <%=errors? errors.CPU : "" %>
                                </p>
                            </div>
                            
                            <div>
                                <label for="os" class="block text-sm font-medium text-gray-700">OS</label>
                                <input type="text" id="os" name="os" class="mt-1 block w-full custom-input" value="<%= formData?.os ||'' %>">
                                <p data-error="os" class="text-red-500 text-xs italic">
                                    <%=errors? errors.os : '' %>
                                </p>
                            </div>
                            <div>
                                <label for="screen" class="block text-sm font-medium text-gray-700">Screen</label>
                                <input type="text" id="screen" name="screen" class="mt-1 block w-full custom-input" value="<%= formData?.screen ||'' %>">
                                <p data-error="screen" class="text-red-500 text-xs italic">
                                    <%=errors? errors.screen : '' %>
                                </p>
                            </div>
                            <div>
                                <label for="graphics" class="block text-sm font-medium text-gray-700">Graphics</label>
                                <input type="text" id="graphics" name="graphics" class="mt-1 block w-full custom-input" value="<%= formData?.graphics ||'' %>">
                                <p data-error="graphics" class="text-red-500 text-xs italic">
                                    <%=errors? errors.graphics : '' %>
                                </p>
                            </div>
                            
                            <div>
                                <label for="regularPrice" class="block text-sm font-medium text-gray-700">Regular
                                    Price</label>
                                <input type="number" id="regularPrice" name="regularPrice"
                                    class="mt-1 block w-full custom-input" value="<%= formData?.regularPrice ||'' %>">
                                <p data-error="regularPrice" class="text-red-500 text-xs italic">
                                    <%=errors? errors.regularPrice : '' %>
                                </p>
                            </div>
                            <div>
                                <label for="salePrice" class="block text-sm font-medium text-gray-700">Sale
                                    Price</label>
                                <input type="number" id="salePrice" name="salePrice"
                                    class="mt-1 block w-full custom-input" value="<%= formData?.salePrice ||'' %>">
                                <p data-error="salePrice" class="text-red-500 text-xs italic">
                                    <%=errors? errors.salePrice : '' %>
                                </p>
                            </div> 
                            <div>
                                    <label for="warranty" class="block text-sm font-medium text-gray-700">Warranty</label>
                                    <input type="text" id="warranty" name="warranty" class="mt-1 block w-full custom-input" value="<%= formData?.warranty ||'' %>">
                                    <p data-error="warranty" class="text-red-500 text-xs italic">
                                        <%=errors? errors.warranty : '' %>
                                    </p>
                                </div>
                            </div>
                            <div class="">
                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea id="description" name="description" class="mt-1 block w-full custom-textarea"
                                        rows="4"><%= formData?.description ||'' %></textarea>
                                    <p data-error="description" class="text-red-500 text-xs italic">
                                        <%=errors? errors.description : '' %>
                                    </p>
                                </div>
                                
                            </div>

                        <fieldset class="nested-fieldset mt-6">
                            <legend>Variants</legend>
                            <div id="variants-container" class="space-y-4">
                                <% (formData?.variants || [{}]).forEach((variant, index) => { %>
                                <div class="variant form-variant-grid" data-index="<%= index %>">
                                    <div>
                                    <label for="variant-ram-<%= index %>" class="block text-sm font-medium text-gray-700">RAM</label>
                                    <input type="text" id="variant-ram-<%= index %>" name="variants[<%= index %>][RAM]" 
                                        class="mt-1 block w-full custom-input" 
                                        value="<%= variant.RAM || '' %>">
                                    <p data-error="variants[<%= index %>][RAM]" class="text-red-500 text-xs italic">
                                        <%= errors?.variants?.[index]?.RAM || '' %>
                                    </p>
                                    </div>

                                    <div>
                                    <label for="variant-storage-<%= index %>" class="block text-sm font-medium text-gray-700">Storage</label>
                                    <input type="text" id="variant-storage-<%= index %>" name="variants[<%= index %>][Storage]" 
                                        class="mt-1 block w-full custom-input" 
                                        value="<%= variant.Storage || '' %>">
                                    <p data-error="variants[<%= index %>][Storage]" class="text-red-500 text-xs italic">
                                        <%= errors?.variants?.[index]?.Storage || '' %>
                                    </p>
                                    </div>

                                    <div>
                                    <label for="variant-priceAdjustment-<%= index %>" class="block text-sm font-medium text-gray-700">Price Adjustment</label>
                                    <input type="number" id="variant-priceAdjustment-<%= index %>" name="variants[<%= index %>][priceAdjustment]" 
                                        class="mt-1 block w-full custom-input" 
                                        value="<%= variant.priceAdjustment || '' %>">
                                        <p data-error="variants[<%= index %>][priceAdjustment]" class="text-red-500 text-xs italic">
                                        <%= errors?.variants?.[index]?.priceAdjustment || '' %></p>
                                    </div>
                                    <div>
                                    <label for="variant-stock-<%= index %>" class="block text-sm font-medium text-gray-700">Stock</label>
                                    <input type="number" id="variant-stock-<%= index %>" name="variants[<%= index %>][stock]" 
                                        class="mt-1 block w-full custom-input" 
                                        value="<%= variant.stock || '' %>">
                                        <p data-error="variants[<%= index %>][stock]" class="text-red-500 text-xs italic">
                                        <%= errors?.variants?.[index]?.stock || '' %></p>
                                    </div>

                                    <div class="flex items-end">
                                    <button type="button" class="remove-variant inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 <%= index === 0 ? 'hidden' : '' %>" 
                                        data-index="<%= index %>">Remove</button>
                                    </div>
                                </div>
                                <% }) %>
                            </div>

                            <button type="button" id="add-variant"
                                class="mt-4 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Variant</button>
                        </fieldset>

                        <fieldset class="nested-fieldset mt-6">
                            <legend>Ports</legend>
                            <div class="form-field-grid">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">USB Type-A</label>
                                    <input type="text" name="ports[0][USB Type-A]"
                                        class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['USB Type-A'] ||'' %>">
                                    <p data-error="ports[0][USB Type-A]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["USB Type-A"] || '' %>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">USB Type-C</label>
                                    <input type="text" name="ports[0][USB Type-C]"
                                        class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['USB Type-C'] ||'' %>">
                                    <p data-error="ports[0][USB Type-C]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["USB Type-C"] || '' %>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">HDMI</label>
                                    <input type="text" name="ports[0][HDMI]" class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['HDMI'] ||'' %>">
                                    <p data-error="ports[0][HDMI]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["HDMI"] || '' %>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Audio Jack</label>
                                    <input type="text" name="ports[0][AudioJack]"
                                        class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['AudioJack'] ||'' %>">
                                    <p data-error="ports[0][AudioJack]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["AudioJack"] || '' %>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">LAN</label>
                                    <input type="text" name="ports[0][LAN]" class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['LAN'] ||'' %>">
                                    <p data-error="ports[0][LAN]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["LAN"] || '' %>
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Card Reader</label>
                                    <input type="text" name="ports[0][Card Reader]"
                                        class="mt-1 block w-full custom-input" value="<%= formData?.ports[0]['Card Reader'] ||'' %>">
                                    <p data-error="ports[0][Card Reader]" class="text-red-500 text-xs italic">
                                        <%= errors?.ports?.[0]?.["Card Reader"] || '' %>
                                    </p>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="nested-fieldset mt-6">
                            <legend class="font-semibold text-gray-700">Product Images</legend>
                            <div class="form-grid">
                                <!-- Main Photo -->
                                <div class="image-container">
                                    <h2 class="text-lg font-medium mb-4">Main Photo</h2>
                                    <input type="file" id="main-file" name="images[0].file" accept="image/*"
                                        class="hidden custom-file" >
                                    <div class="main-photo" id="main-drop" data-index="0">
                                        <svg class="placeholder-icon" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <p class="text-sm text-gray-600 mt-2 ">Drag and drop image here, or click add
                                            image</p>
                                        <button type="button" class="custom-button mt-4">Add Image</button>
                                        <img id="main-preview" class="image-preview hidden" alt="Main Photo Preview">
                                        <button type="button" id="main-delete"
                                            class="delete-image hidden absolute top-1 right-1 bg-red-600 text-white p-2 rounded-full text-sm font-bold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">✖</button>
                                    </div>
                                    <input type="hidden" name="images[0].isMain" id="hidden-isMain-0" value="true">
                                </div>

                                <div class="image-container">
                                    <h2 class="text-lg font-medium mb-4">Additional Photos</h2>
                                    <div class="photo-grid">
                                        <div>
                                            <input type="file" id="additional-file-1" name="images[1].file"
                                                accept="image/*" class="hidden custom-file">
                                            <div class="additional-photo" id="additional-drop-1" data-index="1">
                                                <svg class="placeholder-icon" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                    </path>
                                                </svg>
                                                <p class="text-sm text-gray-600 mt-2">Drag and drop or click add image
                                                </p>
                                                <button type="button" class="custom-button mt-4">Add Image</button>
                                                <img id="additional-preview-1" class="image-preview hidden"
                                                    alt="Additional Photo 1 Preview">
                                                <button type="button" id="additional-delete-1"
                                                    class="delete-image hidden absolute top-1 right-1 bg-red-600 text-white p-2 rounded-full text-sm font-bold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">✖</button>
                                            </div>
                                            <input type="hidden" name="images[1].isMain" id="hidden-isMain-1"
                                                value="false">
                                        </div>
                                        <div>
                                            <input type="file" id="additional-file-2" name="images[2].file"
                                                accept="image/*" class="hidden custom-file">
                                            <div class="additional-photo" id="additional-drop-2" data-index="2">
                                                <svg class="placeholder-icon" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                    </path>
                                                </svg>
                                                <p class="text-sm text-gray-600 mt-2">Drag and drop or click add image
                                                </p>
                                                <button type="button" class="custom-button mt-4">Add Image</button>
                                                <img id="additional-preview-2" class="image-preview hidden"
                                                    alt="Additional Photo 2 Preview">
                                                <button type="button" id="additional-delete-2"
                                                    class="delete-image hidden absolute top-1 right-1 bg-red-600 text-white p-2 rounded-full text-sm font-bold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">✖</button>
                                            </div>
                                            <input type="hidden" name="images[2].isMain" id="hidden-isMain-2"
                                                value="false">
                                        </div>
                                        <div>
                                            <input type="file" id="additional-file-3" name="images[3].file"
                                                accept="image/*" class="hidden custom-file">
                                            <div class="additional-photo" id="additional-drop-3" data-index="3">
                                                <svg class="placeholder-icon" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                    </path>
                                                </svg>
                                                <p class="text-sm text-gray-600 mt-2">Drag and drop or click add image
                                                </p>
                                                <button type="button" class="custom-button mt-4">Add Image</button>
                                                <img id="additional-preview-3" class="image-preview hidden"
                                                    alt="Additional Photo 3 Preview">
                                                <button type="button" id="additional-delete-3"
                                                    class="delete-image hidden absolute top-1 right-1 bg-red-600 text-white p-2 rounded-full text-sm font-bold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">✖</button>
                                            </div>
                                            <input type="hidden" name="images[3].isMain" id="hidden-isMain-3"
                                                value="false">
                                        </div>
                                        <div>
                                            <input type="file" id="additional-file-4" name="images[4].file"
                                                accept="image/*" class="hidden custom-file">
                                            <div class="additional-photo" id="additional-drop-4" data-index="4">
                                                <svg class="placeholder-icon" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                    </path>
                                                </svg>
                                                <p class="text-sm text-gray-600 mt-2">Drag and drop or click add image
                                                </p>
                                                <button type="button" class="custom-button mt-4">Add Image</button>
                                                <img id="additional-preview-4" class="image-preview hidden" alt="Additional Photo 4 Preview">
                                                <button type="button" id="additional-delete-4" class="delete-image hidden absolute top-1 right-1 bg-red-600 text-white p-2 rounded-full text-sm font-bold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">✖</button>
                                            </div>
                                            <input type="hidden" name="images[4].isMain" id="hidden-isMain-4" value="false">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <div class="mt-6">
                            <label for="isActive" class="inline-flex items-center text-sm font-medium text-gray-700">
                                <input type="checkbox" id="isActive" name="isActive" checked class="mr-2 custom-checkbox"> Show in Shopping Page
                            </label>
                        </div>

                        <div class="mt-6 flex space-x-4">
                            <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Product</button>
                            <button type="button" onclick="window.location.href='/admin/products'" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Cancel</button>
                        </div>
                </form>
            </main>
    </div>

    <div id="cropModal">
        <div class="cropper-container">
            <img id="cropImage" alt="Image to Crop">
            <div class="cropper-buttons">
                <button type="button" id="cropConfirm"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Crop
                    & Save</button>
                <button type="button" id="cropCancel"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
    <script>
    let variantIndex = 1;
    let cropper = null;
    let currentFileInput = null;
    let currentPreview = null;
    let currentText = null;
    let currentAddButton = null;
    let currentDeleteButton = null;

    function updateRemoveButtons() {
        const variants = document.querySelectorAll('.variant');
        variants.forEach((variant, index) => {
            const removeButton = variant.querySelector('.remove-variant');
            if (removeButton) {
                removeButton.classList.toggle('hidden', index === 0);
            }
        });
    }

    function setupVariantAddRemove() {
        document.getElementById('add-variant').addEventListener('click', () => {
            const container = document.getElementById('variants-container');
            const newVariant = document.createElement('div');
            newVariant.className = 'variant form-variant-grid';
            newVariant.dataset.index = variantIndex;

            newVariant.innerHTML = `
                <div>
                    <label for="variant-ram-${variantIndex}" class="block text-sm font-medium text-gray-700">RAM</label>
                    <input type="text" id="variant-ram-${variantIndex}" name="variants[${variantIndex}][RAM]" class="mt-1 block w-full custom-input">
                </div>
                <div>
                    <label for="variant-storage-${variantIndex}" class="block text-sm font-medium text-gray-700">Storage</label>
                    <input type="text" id="variant-storage-${variantIndex}" name="variants[${variantIndex}][Storage]" class="mt-1 block w-full custom-input">
                </div>
                <div>
                    <label for="variant-priceAdjustment-${variantIndex}" class="block text-sm font-medium text-gray-700">Price Adjustment</label>
                    <input type="number" id="variant-priceAdjustment-${variantIndex}" name="variants[${variantIndex}][priceAdjustment]" class="mt-1 block w-full custom-input">
                </div>
                <div>
                    <label for="variant-stock-${variantIndex}" class="block text-sm font-medium text-gray-700">Stock</label>
                    <input type="number" id="variant-stock-${variantIndex}" name="variants[${variantIndex}][stock]" class="mt-1 block w-full custom-input">
                </div>
                <div class="flex items-end">
                    <button type="button" class="remove-variant inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700" data-index="${variantIndex}">Remove</button>
                </div>
            `;

            container.appendChild(newVariant);
            variantIndex++;
            updateRemoveButtons();

            newVariant.querySelector('.remove-variant').addEventListener('click', () => {
                newVariant.remove();
                const remainingVariants = document.querySelectorAll('.variant');
                remainingVariants.forEach((variant, idx) => {
                    variant.dataset.index = idx;
                    const inputs = variant.querySelectorAll('input');
                    inputs[0].id = `variant-ram-${idx}`;
                    inputs[0].name = `variants[${idx}].RAM`;
                    inputs[1].id = `variant-storage-${idx}`;
                    inputs[1].name = `variants[${idx}].Storage`;
                    inputs[2].id = `variant-priceAdjustment-${idx}`;
                    inputs[2].name = `variants[${idx}].priceAdjustment`;
                    inputs[3].id = `variant-stock-${idx}`;
                    inputs[3].name = `variants[${idx}].stock`;
                    const removeButton = variant.querySelector('.remove-variant');
                    if (removeButton) removeButton.dataset.index = idx;
                });
                variantIndex = remainingVariants.length;
                updateRemoveButtons();
            });
        });
    }

    function setupDragAndDrop(dropArea, fileInput, preview, deleteButton) {
        const text = dropArea.querySelector('p');
        const buttons = dropArea.querySelectorAll('button');
        const addButton = Array.from(buttons).find(btn => !btn.classList.contains('delete-image'));

        const handleFile = (file) => {
            if (!file.type.startsWith('image/')) {
                const pageTitle = document.querySelector('h1').textContent.trim();
                const isEditPage = pageTitle.includes('Product Details') || pageTitle.includes('Edit');
                const actionText = isEditPage ? 'updating the product' : 'adding a new product';
                
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File Type',
                    text: `Please select an image file (jpg, jpeg, png) for ${actionText}.`,
                    confirmButtonColor: '#dc2626'
                });
                return;
            }

            currentFileInput = fileInput;
            currentPreview = preview;
            currentText = text;
            currentAddButton = addButton;
            currentDeleteButton = deleteButton;

            const reader = new FileReader();
            reader.onload = (e) => {
                const cropImage = document.getElementById('cropImage');
                cropImage.src = e.target.result;
                document.getElementById('cropModal').style.display = 'flex';

                if (cropper) cropper.destroy();
                const isMainPhoto = preview.closest('.main-photo');
                cropper = new Cropper(cropImage, {
                    aspectRatio: 800 / 600 ,
                    viewMode: 0,
                    autoCropArea: 0.8,
                    responsive:true,
                    zoomWheel : true,
                    scalable : true,
                    Zoomable:true,
                });
            };
            reader.readAsDataURL(file);
        };

        addButton?.addEventListener('click', e => {
            e.stopPropagation();
            fileInput.click();
        });

        dropArea.addEventListener('click', () => fileInput.click());

        dropArea.addEventListener('dragover', e => {
            e.preventDefault();
            dropArea.classList.add('drag-active');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('drag-active');
        });

        dropArea.addEventListener('drop', e => {
            e.preventDefault();
            dropArea.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files[0]) handleFile(fileInput.files[0]);
        });

        deleteButton.addEventListener('click', e => {
            e.stopPropagation();
            clearImage(preview, text, addButton, fileInput, deleteButton);
        });
    }

    function clearImage(preview, text, addButton, fileInput, deleteButton) {
        preview.src = '';
        preview.classList.add('hidden');
        text.classList.remove('hidden');
        addButton.classList.remove('hidden');
        deleteButton.classList.add('hidden');
        fileInput.value = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll("input[type='file']").forEach(input => input.value = '');

        const cropModal = document.getElementById('cropModal');
        cropModal.style.display = 'none';

        setupVariantAddRemove();

        const mainDropArea = document.getElementById('main-drop');
        if (mainDropArea) {
            setupDragAndDrop(
                mainDropArea,
                document.getElementById('main-file'),
                document.getElementById('main-preview'),
                document.getElementById('main-delete')
            );
        }

        for (let i = 1; i <= 4; i++) {
            const dropArea = document.getElementById(`additional-drop-${i}`);
            if (dropArea) {
                setupDragAndDrop(
                    dropArea,
                    document.getElementById(`additional-file-${i}`),
                    document.getElementById(`additional-preview-${i}`),
                    document.getElementById(`additional-delete-${i}`)
                );
            }
        }

        document.querySelectorAll('[data-error]').forEach(p => {
            if (p.textContent.trim() !== '') {
                const fieldName = p.getAttribute('data-error');
                const input = document.querySelector(`[name="${CSS.escape(fieldName)}"]`);
                if (input) input.classList.add('input-error');
            }
        });

        updateRemoveButtons();
    });

    // Crop Confirm
    document.getElementById('cropConfirm').addEventListener('click', () => {
        if (!cropper) return;

        const isMainPhoto = currentPreview.closest('.main-photo');
        const croppedCanvas = cropper.getCroppedCanvas({
            width: isMainPhoto ? 400 : 150,
            height: isMainPhoto ? 300 : 150,
        });

        currentPreview.src = croppedCanvas.toDataURL('image/jpeg');
        currentPreview.classList.remove('hidden');
        currentText.classList.add('hidden');
        currentAddButton.classList.add('hidden');
        currentDeleteButton.classList.remove('hidden');

        croppedCanvas.toBlob((blob) => {
            const file = new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            currentFileInput.files = dataTransfer.files;
        }, 'image/jpeg');

        document.getElementById('cropModal').style.display = 'none';
        cropper.destroy();
        cropper = null;
    });

    document.getElementById('cropCancel').addEventListener('click', () => {
        document.getElementById('cropModal').style.display = 'none';
        if (cropper) cropper.destroy();
        cropper = null;
        clearImage(currentPreview, currentText, currentAddButton, currentFileInput, currentDeleteButton);
    });
</script>      
</body>
</html>