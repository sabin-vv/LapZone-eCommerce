<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= product.name %> - LapZone
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/productPage.css">
    <script src="https://unpkg.com/js-image-zoom@0.4.1/js-image-zoom.js" type="application/javascript"></script>
    
</head>

<body>
    <%- include("../partials/user/header.ejs") %>

        <div class="product-container">
            <!-- Product Images -->
            <div class="product-images">
                <div id="mainImageContainer">
                    <img src="<%= product.images.find(img => img.isMain)?.url || 'https://placehold.co/600x400' %>"
                    alt="<%= product.name %>" class="main-image" id="mainImage">
                </div>
                <div class="d-flex flex-wrap">
                    <% product.images.forEach(img=> { %>
                        <img src="<%= img.url %>" alt="<%= product.name %> thumbnail"
                            class="thumbnail <%= img.isMain ? 'active' : '' %>" onclick="changeImage('<%= img.url %>')">
                        <% }) %>
                </div>
            </div>

            <!-- Product Details -->
            <div class="product-details">
                <nav class="breadcrumb" id="breadcrumb">

                </nav>
                <h1>
                    <%= product.name %>
                </h1>
                <div class="rating">
                    <% for (let i=1; i <=5; i++) { %>
                        <% if (i <=Math.floor(product.rating)) { %>
                            <span>★</span>
                            <% } else if (i===Math.ceil(product.rating) && product.rating % 1 !==0) { %>
                                <span>☆</span>
                                <% } else { %>
                                    <span>☆</span>
                                    <% } %>
                                        <% } %>
                                            <span class="text-muted ms-2">(<%= product.rating.toLocaleString('en-IN', {
                                                    minimumFractionDigits: 1, maximumFractionDigits: 1 }) %>/5)</span>
                </div>
                <% if (product.regularPrice && product.salePrice < product.regularPrice) { %>
                    <div class="price">
                        ₹<%= product.salePrice.toLocaleString('en-IN') %>
                            <del>₹<%= product.regularPrice.toLocaleString('en-IN') %></del>
                    </div>
                    <% } else { %>
                        <div class="price">₹<%= product.salePrice.toLocaleString('en-IN') %>
                        </div>
                        <% } %>
                            <div class="description">
                                <%= product.description || 'No description available.' %>
                            </div>
                            <div class="offers">
                                <ul>
                                    <% if (product.offer && product.offer> 0) { %>
                                        <li>
                                            <%= product.offer %>% off on this product!
                                        </li>
                                        <% } else { %>
                                            <li>No offers available.</li>
                                            <% } %>
                                </ul>
                            </div>
                            <div class="variant-selector">
                                <div>RAM</div>
                                <div class="variant-options">
                                    <% product.variants.forEach(variant=> { %>
                                        <button
                                            class="variant-btn <%= variant.RAM === product.variants[0].RAM ? 'active' : '' %>"
                                            onclick="selectVariant(this, 'RAM', '<%= variant.RAM %>')">
                                            <%= variant.RAM %>
                                        </button>
                                        <% }) %>
                                </div>
                                <div>Storage</div>
                                <div class="variant-options">
                                    <% product.variants.forEach(variant=> { %>
                                        <button
                                            class="variant-btn <%= variant.Storage === product.variants[0].Storage ? 'active' : '' %>"
                                            onclick="selectVariant(this, 'Storage', '<%= variant.Storage %>')">
                                            <%= variant.Storage %>
                                        </button>
                                        <% }) %>
                                </div>
                            </div>
                            <!-- Specifications Section -->

                            <button class="add-to-cart-btn" onclick="addToCart('<%= product._id %>')">
                                Add to Cart
                                <i class="bi bi-cart-plus"></i>
                            </button>
            </div>
        </div>
        <div class="container my-5 px-3 px-md-5">
            <div class="specifications">
                <h2>Specifications</h2>
                <dl>
                    <% if (product.name) { %>
                        <dt>Model Name</dt>
                        <dd><%= product.name %></dd>
                    <% } %>
                    <% if (product.brand) { %>
                        <dt>Brand</dt>
                        <dd><%= product.brand %></dd>
                    <% } %>
                    <% if (product.modelNumber) { %>
                        <dt>Model Number</dt>
                        <dd><%= product.modelNumber %></dd>
                    <% } %>
                    <% if (product.category) { %>
                        <dt>Category</dt>
                        <dd><%= product.category %></dd>
                    <% } %>
                    <% if (product.color) { %>
                        <dt>Colour</dt>
                        <dd><%= product.color %></dd>
                    <% } %>
                    <% if (product.CPU) { %>
                        <dt>Processor</dt>
                        <dd><%= product.CPU %></dd>
                    <% } %>
                    <% if (product.OS) { %>
                        <dt>Operating System</dt>
                        <dd><%= product.OS %></dd>
                    <% } %>
                    <% if (product.screen) { %>
                        <dt>Display</dt>
                        <dd><%= product.screen %></dd>
                    <% } %>
                    <% if (product.webcam) { %>
                        <dt>Web Camera</dt>
                        <dd><%= product.webcam %></dd>
                    <% } %>
            
                    <% if (product.ports && product.ports.length > 0) {
                        const portEntry = product.ports[0];
                    %>
                        <% if (portEntry['USB Type-A']) { %>
                            <dt>USB Type-A</dt>
                            <dd><%= portEntry['USB Type-A'] %></dd>
                        <% } %>
                        <% if (portEntry['USB Type-C']) { %>
                            <dt>USB Type-C</dt>
                            <dd><%= portEntry['USB Type-C'] %></dd>
                        <% } %>
                        <% if (portEntry['HDMI']) { %>
                            <dt>HDMI</dt>
                            <dd><%= portEntry['HDMI'] %></dd>
                        <% } %>
                        <% if (portEntry['AudioJack']) { %>
                            <dt>Audio Jack</dt>
                            <dd><%= portEntry['AudioJack'] %></dd>
                        <% } %>
                        <% if (portEntry['LAN']) { %>
                            <dt>LAN</dt>
                            <dd><%= portEntry['LAN'] %></dd>
                        <% } %>
                        <% if (portEntry['Card Reader']) { %>
                            <dt>Card Reader</dt>
                            <dd><%= portEntry['Card Reader'] %></dd>
                        <% } %>
                    <% } %>
                    <% if (product.warranty) { %>
                        <dt>Warranty</dt>
                        <dd><%= product.warranty %></dd>
                    <% } %>
                </dl>
            </div>
        </div>

        <div class="suggestions">
            <h1>Suggestions</h1>
            <div class="row">
                <div class="suggestion-grid"></div>
                <% productSuggesions.forEach(suggesion => { 
                    const mainImage = suggesion.images.find(img => img.isMain);
                    const variant = suggesion.variants?.[0];
                %>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="suggestion card">
                            <a href="/shop/product/<%= suggesion._id %>">
                                <img src="<%= mainImage?.url || 'https://placehold.co/300x200' %>" alt="<%= suggesion.name %>">
                                <div class="card-body">
                                    <h5 class="card-title"><%= suggesion.name %></h5>
                                    <p class="card-text">
                                        <%= suggesion.CPU %> | <%= variant?.RAM || 'N/A' %> | <%= variant?.Storage || 'N/A' %> 
                                    </p>
                                </div>
                                <p class="card-footer">₹<%= suggesion.salePrice %></p>
                            </a>
                        </div>
                    </div>
                <% }) %>
            </div>
            </div>
        </div>
            
        


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
        <script>

            let options = {
                width: 570,
                zoomWidth: 350, 
                offset: { vertical: 0, horizontal: 10 },
                zoomStyle: ' z-index: 1000;',
            }

            new ImageZoom(document.getElementById("mainImageContainer"), options);
            
            // Change main image on thumbnail click
            function changeImage(url) {
                document.getElementById('mainImage').src = url;
                document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
                event.target.classList.add('active');
            }

            // Select variant (RAM or Storage)
            function selectVariant(btn, type, value) {
                document.querySelectorAll(`.variant-btn`).forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
            }

            document.addEventListener('DOMContentLoaded', () => {
                console.log('Header element:', document.querySelector('header'));
            });


            function generateBreadcrumb() {
                const breadcrumbContainer = document.getElementById("breadcrumb");
                const pathArray = window.location.pathname.split("/").filter(p => p);

                const isID = (segment) => /^[0-9a-fA-F]{24}$/.test(segment) || /^\d+$/.test(segment);

                let breadcrumbHTML = `<a href="/">Home</a>`;
                let fullPath = "";

                pathArray.forEach((segment, index) => {
                    const isLast = index === pathArray.length - 1;
                    const nextIsID = isLast ? false : isID(pathArray[index + 1]);

                    // Skip segment if it's an ID
                    if (isID(segment)) return;

                    fullPath += `/${segment}`;

                    // If the next segment is an ID, don't make this a link
                    if (nextIsID || isLast) {
                        breadcrumbHTML += ` <span>›</span> <span>${decodeURIComponent(segment)}</span>`;
                    } else {
                        breadcrumbHTML += ` <span>›</span> <a href="${fullPath}">${decodeURIComponent(segment)}</a>`;
                    }
                });

                breadcrumbContainer.innerHTML = breadcrumbHTML;
            }

            document.addEventListener("DOMContentLoaded", generateBreadcrumb);

        </script>

</body>

</html>