<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Coupons | LapZone</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/profileSidebar.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --danger-color: #ef4444;
            --danger-light: #fee2e2;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-accent: #f3f4f6;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .coupon-container {
            flex: 1;
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title i {
            color: var(--primary-color);
        }

        .coupon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .coupon-card {
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .coupon-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .coupon-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            position: relative;
        }

        .coupon-expired .coupon-header {
            background: linear-gradient(135deg, var(--text-muted) 0%, var(--text-secondary) 100%);
            opacity: 0.8;
        }

        .coupon-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 20px;
            background-image: radial-gradient(circle at 10px 10px, transparent 12px, white 13px);
            background-size: 20px 20px;
            background-position: -10px -10px;
        }

        .coupon-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .coupon-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .coupon-min-purchase {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .coupon-body {
            padding: 1.5rem 1.25rem 1rem;
        }

        .coupon-code-container {
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
            background-color: var(--bg-accent);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            position: relative;
        }

        .coupon-code {
            flex: 1;
            font-family: monospace;
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-primary);
            padding: 0.5rem;
            text-align: center;
            background: transparent;
            border: none;
            outline: none;
            cursor: pointer;
        }

        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .copy-btn:hover {
            background-color: var(--primary-dark);
        }

        .coupon-expired .copy-btn {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        .coupon-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .coupon-footer {
            padding: 1rem 1.25rem;
            border-top: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coupon-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-active {
            color: var(--success-color);
        }

        .status-expired {
            color: var(--text-secondary);
        }

        .coupon-usage {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .coupon-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-bottom-left-radius: var(--radius-md);
            z-index: 1;
        }

        .badge-new {
            background-color: var(--success-color);
            color: white;
        }

        .badge-expiring {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-expired {
            background-color: var(--danger-color);
            color: white;
        }

        .coupon-expired {
            opacity: 0.75;
        }

        .coupon-expired::before {
            content: 'EXPIRED';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 2rem;
            font-weight: 800;
            color: var(--danger-color);
            border: 4px solid var(--danger-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            z-index: 2;
            opacity: 0.8;
            pointer-events: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-message {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .btn-shop {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-shop:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: white;
        }

        .tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-primary);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            white-space: nowrap;
            z-index: 10;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary) transparent transparent transparent;
        }

        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .coupon-container {
                padding: 1.5rem 0.75rem;
            }

            .coupon-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
                margin: 0 auto;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Coupon scissors effect */
        .scissors {
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-color: var(--bg-secondary);
            border-radius: 50%;
            z-index: 1;
        }

        .scissors::before {
            content: '✂️';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        .scissors-right {
            left: auto;
            right: -10px;
        }
    </style>
</head>
<body>
    <%- include("../partials/user/header.ejs") %>
    
    <div class="main-content">
        <%- include("../partials/user/profileSidebar.ejs") %>
        
        <div class="coupon-container">
            <h1 class="page-title">
                <i class="fa-solid fa-ticket"></i>
                My Coupons
            </h1>
            
            <% if (coupons && coupons.length > 0) { %>
                <div class="coupon-grid">
                    <% coupons.forEach((coupon, index) => { 
                        const now = new Date();
                        const isExpired = now > new Date(coupon.expiryDate);
                        const isExpiringSoon = !isExpired && ((new Date(coupon.expiryDate) - now) / (1000 * 60 * 60 * 24)) <= 3;
                        const isNew = ((now - new Date(coupon.startDate)) / (1000 * 60 * 60 * 24)) <= 3;
                        
                        // Format dates
                        const startDate = new Date(coupon.startDate).toLocaleDateString('en-US', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric' 
                        });
                        
                        const expiryDate = new Date(coupon.expiryDate).toLocaleDateString('en-US', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric' 
                        });
                    %>
                        <div class="coupon-card fade-in <%= isExpired ? 'coupon-expired' : '' %>" style="animation-delay: <%= index * 0.1 %>s">
                            <% if (isNew && !isExpired) { %>
                                <div class="coupon-badge badge-new">NEW</div>
                            <% } else if (isExpiringSoon) { %>
                                <div class="coupon-badge badge-expiring">EXPIRING SOON</div>
                            <% } else if (isExpired) { %>
                                <div class="coupon-badge badge-expired">EXPIRED</div>
                            <% } %>
                            
                            <div class="coupon-header">
                                <div class="coupon-type"><%= coupon.discountType === 'percentage' ? 'Percentage Discount' : 'Fixed Amount Off' %></div>
                                <div class="coupon-value">
                                    <%= coupon.discountType === 'percentage' ? coupon.discountValue + '%' : '₹' + coupon.discountValue %>
                                    <%= coupon.discountType === 'percentage' && coupon.maxDiscountAmount ? ' up to ₹' + coupon.maxDiscountAmount : '' %>
                                </div>
                                <div class="coupon-min-purchase">
                                    <% if (coupon.minPurchaseAmount > 0) { %>
                                        Min. Purchase: ₹<%= coupon.minPurchaseAmount.toLocaleString('en-IN') %>
                                    <% } else { %>
                                        No minimum purchase required
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="coupon-body">
                                <div class="coupon-code-container">
                                    <input type="text" class="coupon-code" value="<%= coupon.code %>" readonly>
                                    <button class="copy-btn" data-code="<%= coupon.code %>" <%= isExpired ? 'disabled' : '' %>>
                                        <i class="fa-regular fa-copy"></i>
                                        Copy
                                    </button>
                                    <div class="tooltip">Copied!</div>
                                </div>
                                
                                <div class="coupon-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Valid From</span>
                                        <span class="detail-value"><%= startDate %></span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Valid Until</span>
                                        <span class="detail-value"><%= expiryDate %></span>
                                    </div>
                                    
                                    <% if (coupon.usageLimit) { %>
                                        <div class="detail-item">
                                            <span class="detail-label">Total Usage</span>
                                            <span class="detail-value"><%= coupon.usedCount %>/<%= coupon.usageLimit %></span>
                                        </div>
                                    <% } %>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Usage Per User</span>
                                        <span class="detail-value"><%= coupon.usageLimitPerUser %> time<%= coupon.usageLimitPerUser !== 1 ? 's' : '' %></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="scissors"></div>
                            <div class="scissors scissors-right"></div>
                            
                            <div class="coupon-footer">
                                <div class="coupon-status">
                                    <% if (!isExpired && coupon.isActive) { %>
                                        <i class="fa-solid fa-circle-check status-active"></i>
                                        <span class="status-active">Active</span>
                                    <% } else { %>
                                        <i class="fa-solid fa-circle-xmark status-expired"></i>
                                        <span class="status-expired">Expired</span>
                                    <% } %>
                                </div>
                                
                                <div class="coupon-usage">
                                    <% if (coupon.usedByUser && coupon.usedByUser > 0) { %>
                                        Used <%= coupon.usedByUser %> time<%= coupon.usedByUser !== 1 ? 's' : '' %>
                                    <% } else { %>
                                        Not used yet
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fa-solid fa-ticket-simple"></i>
                    </div>
                    <h2 class="empty-title">No Coupons Available</h2>
                    <p class="empty-message">
                        You don't have any coupons at the moment. Check back later or shop to earn special discounts!
                    </p>
                    <a href="/shop" class="btn-shop">
                        <i class="fa-solid fa-bag-shopping"></i>
                        Start Shopping
                    </a>
                </div>
            <% } %>
        </div>
    </div>
    
    <%- include("../partials/user/footer.ejs") %>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const copyButtons = document.querySelectorAll('.copy-btn');
            
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (this.hasAttribute('disabled')) return;
                    
                    const code = this.getAttribute('data-code');
                    const tooltip = this.nextElementSibling;
                    
                    const tempInput = document.createElement('input');
                    tempInput.value = code;
                    document.body.appendChild(tempInput);
                    
                    tempInput.select();
                    document.execCommand('copy');
                    
                    // Remove the temporary input
                    document.body.removeChild(tempInput);
                    
                    tooltip.classList.add('show');
                    
                    this.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                    
                    setTimeout(() => {
                        this.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
                        tooltip.classList.remove('show');
                    }, 2000);
                });
            });
            
            // Highlight active sidebar item
            const currentPath = window.location.pathname;
            const menuItems = document.querySelectorAll('.sidebar ul li a');
            
            menuItems.forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.parentElement.classList.add('active');
                }
            });
            
            // Mobile sidebar toggle
            const toggleBtn = document.querySelector('.toggle-sidebar');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
            }
            
            if (overlay) {
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>